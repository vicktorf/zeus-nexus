apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-data-pvc
  namespace: ac-agentic
  labels:
    app: gitlab-ce
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: ac-bronze-single

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-config-pvc
  namespace: ac-agentic
  labels:
    app: gitlab-ce
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: ac-bronze-single

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-logs-pvc
  namespace: ac-agentic
  labels:
    app: gitlab-ce
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: ac-bronze-single

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab-ce
  namespace: ac-agentic
  labels:
    app: gitlab-ce
    component: git-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitlab-ce
  template:
    metadata:
      labels:
        app: gitlab-ce
        component: git-server
    spec:
      serviceAccountName: zeus-service-account
      securityContext:
        fsGroup: 998
        runAsUser: 998
      containers:
        - name: gitlab
          image: gitlab/gitlab-ce:16.6.0-ce.0
          ports:
            - containerPort: 80
              name: http
            - containerPort: 443
              name: https
            - containerPort: 22
              name: ssh
          env:
            - name: GITLAB_OMNIBUS_CONFIG
              value: |
                external_url 'https://gitlab-ac-agentic.apps.prod01.fis-cloud.fpt.com'
                gitlab_rails['gitlab_shell_ssh_port'] = 2222
                gitlab_rails['initial_root_password'] = 'zeus123456'
                nginx['listen_port'] = 80
                nginx['listen_https'] = false
                nginx['redirect_http_to_https'] = false
                gitlab_rails['store_initial_root_password'] = true
                gitlab_rails['display_initial_root_password'] = true
                # Reduce memory usage
                puma['worker_processes'] = 2
                sidekiq['max_concurrency'] = 10
                prometheus_monitoring['enable'] = false
                grafana['enable'] = false
                # Disable unused services
                gitlab_kas['enable'] = false
                pages_nginx['enable'] = false
          resources:
            requests:
              memory: "4Gi"
              cpu: "1"
            limits:
              memory: "8Gi"
              cpu: "4"
          volumeMounts:
            - name: gitlab-data
              mountPath: /var/opt/gitlab
            - name: gitlab-config
              mountPath: /etc/gitlab
            - name: gitlab-logs
              mountPath: /var/log/gitlab
          livenessProbe:
            httpGet:
              path: /-/health
              port: 80
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 30
            failureThreshold: 10
          readinessProbe:
            httpGet:
              path: /-/readiness
              port: 80
            initialDelaySeconds: 180
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 6
      volumes:
        - name: gitlab-data
          persistentVolumeClaim:
            claimName: gitlab-data-pvc
        - name: gitlab-config
          persistentVolumeClaim:
            claimName: gitlab-config-pvc
        - name: gitlab-logs
          persistentVolumeClaim:
            claimName: gitlab-logs-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: gitlab-ce
  namespace: ac-agentic
  labels:
    app: gitlab-ce
    component: git-server
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
      name: http
    - port: 443
      targetPort: 443
      protocol: TCP
      name: https
  selector:
    app: gitlab-ce

---
apiVersion: v1
kind: Service
metadata:
  name: gitlab-ssh
  namespace: ac-agentic
  labels:
    app: gitlab-ce
    component: git-server
spec:
  type: NodePort
  ports:
    - port: 22
      targetPort: 22
      protocol: TCP
      name: ssh
      nodePort: 32222
  selector:
    app: gitlab-ce

---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: gitlab-ce
  namespace: ac-agentic
  labels:
    app: gitlab-ce
    component: git-server
  annotations:
    haproxy.router.openshift.io/timeout: "600s"
spec:
  host: gitlab-ac-agentic.apps.prod01.fis-cloud.fpt.com
  to:
    kind: Service
    name: gitlab-ce
    weight: 100
  port:
    targetPort: http
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
  wildcardPolicy: None